#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define MAX_PLAYERS 4
#define grille_MIN_SIZE 15
#define grille_MAX_SIZE 20
#define NUM_TARGETS 18

typedef struct {
    int x;
    int y;
} Position;

typedef struct {
    Position pos;
    char target;
    int movesPredicted;
    int movesTaken;
} Player;

char grille[grille_MAX_SIZE][grille_MAX_SIZE];
char targets[NUM_TARGETS];

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void initializegrille(int tailleGrille, int numPlayers, Player *players) {
    // Initialiser la grille avec des espaces vides
    for (int i = 0; i < tailleGrille; i++) {
        for (int j = 0; j < tailleGrille; j++) {
            grille[i][j] = ' ';
        }
    }

    // Placer les murs autour de la grille
    for (int i = 0; i < tailleGrille; i++) {
        grille[0][i] = '#';  // Mur supérieur
        grille[i][0] = '#';  // Mur gauche
        grille[tailleGrille-1][i] = '#';  // Mur inférieur
        grille[i][tailleGrille-1] = '#';  // Mur droit
    }
    

    // Initialiser les cibles
    for (int i = 0; i < NUM_TARGETS; i++) {
        targets[i] = 'A' + i;
    }

    // Placer les cibles (18 cibles représentées par des lettres de A à R)
    for (int i = 0; i < NUM_TARGETS; i++) {
        int x, y;
        int validPosition;
        int random;
        do {
            validPosition = 1;
            x = rand() % (tailleGrille - 4) + 2;  // Éviter les bords
            y = rand() % (tailleGrille - 4) + 2;  // Éviter les bords

            // Vérifier que la cible n'est pas à côté d'une autre cible
            for (int dx = -1; dx <= 1; dx++) {
                for (int dy = -1; dy <= 1; dy++) {
                    if (grille[x + dx][y + dy] >= 'A' && grille[x + dx][y + dy] <= 'R') {
                        validPosition = 0;
                        break;
                    }
                }
                if (!validPosition) break;
            }
        } while (!validPosition);

        grille[x][y] = targets[i];  // Marquer la position de la cible avec une lettre
        
        // Placer des murs formant un angle autour de la cible
        
        random = rand () % 4;
        switch (random) {
            case 0:
                grille[x][y-1] = '#';
                grille[x+1][y] = '#';
                break;
            case 1:
                grille[x][y-1] = '#';
                grille[x-1][y] = '#';
                break;
            case 2:
                grille[x][y+1] = '#';
                grille[x+1][y] = '#';
                break;
            case 3:
                grille[x][y+1] = '#';
                grille[x-1][y] = '#';
                break;
            default:
                break;
        
        }
    }
    
    // Placer les murs perpendiculaires aux bordures
    for (int i = 0; i < 2 ; i++){
        int r;
        r = rand() % (tailleGrille - 2) + 1;
        while (grille[1][r] == '#'){
            r = rand() % (tailleGrille - 2) + 1;
        }
        grille[1][r] = '#'; // Mur supérieur
        
        
        r = rand() % (tailleGrille - 2) + 1;
        while (grille[r][1] == '#'){
            r = rand() % (tailleGrille - 2) + 1;
        }
        grille[r][1] = '#'; // Mur gauche
        
        
        r = rand() % (tailleGrille - 2) + 1;
        while (grille[tailleGrille- 2][r] == '#'){
            r = rand() % (tailleGrille - 2) + 1;
        }
        grille[tailleGrille- 2][r] = '#';    // Mur inférieur
        
        
        r = rand() % (tailleGrille - 2) + 1;
        while (grille[r][tailleGrille- 2] == '#'){
             r = rand() % (tailleGrille - 2) + 1;
        }
        grille[r][tailleGrille- 2] = '#';  // Mur droit
    
    }
    
    // Placer les joueurs sur des positions aléatoires distinctes
    for (int i = 0; i < numPlayers; i++) {
        int x, y;
        do {
            x = rand() % (tailleGrille - 2) + 1;
            y = rand() % (tailleGrille - 2) + 1;
        } while (grille[x][y] != ' '); // Assurer que la position est vide
        players[i].pos.x = x;
        players[i].pos.y = y;
        grille[x][y] = '1' + i;  // Marquer la position du joueur avec son numéro
    }
        
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void displaygrille(int tailleGrille) {
    system("clear");  // Effacer le terminal (Linux)
    for (int i = 0; i < tailleGrille; i++) {
        for (int j = 0; j < tailleGrille; j++) {
            if (grille[i][j] == '#') {
                printf( "\033[36m" "%c " "\033[0m", grille[i][j]); 
                
            }
            
            else if(grille[i][j] >='A' && grille[i][j]<='R') {
                printf ("\033[33m" "%c " "\033[0m", grille[i][j]);
            }
            
            else{
                printf("%c ", grille[i][j]);
            }
        }
        printf("\n");
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void movePlayer(Player *player, char direction, int tailleGrille, Player *players, int targetReached) {
    int newX = player->pos.x;
    int newY = player->pos.y;
    int dx = 0, dy = 0;
    static char previousValue = ' '; // Ajout d'une variable statique pour mémoriser la valeur précédente de la case

    switch (direction) {
        case 'h': case 'H': dx = -1; break; // Haut
        case 'b': case 'B': dx = 1; break;  // Bas
        case 'g': case 'G': dy = -1; break; // Gauche
        case 'd': case 'D': dy = 1; break;  // Droite
        default: break;
    }

    while (1) {
        int nextX = newX + dx;
        int nextY = newY + dy;

        // Vérifier si le déplacement est valide
        if (nextX < 0 || nextX >= tailleGrille || nextY < 0 || nextY >= tailleGrille || grille[nextX][nextY] == '#' || (grille[nextX][nextY] >= '1' && grille[nextX][nextY] <= '4')) {
            break; // Sortir de la boucle si un obstacle est rencontré
        }

        newX = nextX;
        newY = nextY;
    }
    
    if (grille[newX][newY] == player->target) {
        grille[player->pos.x][player->pos.y] = previousValue; // Restaurer la valeur précédente de la case
        previousValue = grille[newX][newY]; // Sauvegarder la nouvelle valeur de la case
        player->pos.x = newX;
        player->pos.y = newY;
        grille[newX][newY] = player->target;
    }
    else{
        // Mettre à jour la grille
        grille[player->pos.x][player->pos.y] = previousValue; // Restaurer la valeur précédente de la case
        previousValue = grille[newX][newY]; // Sauvegarder la nouvelle valeur de la case
        player->pos.x = newX;
        player->pos.y = newY;
        grille[newX][newY] = '1' + (player - players); // Mettre à jour la position du joueur sur la grille
    }
}




////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void playGame(int tailleGrille, int numPlayers, int numRounds) {
    Player players[MAX_PLAYERS];
    int roundScores[MAX_PLAYERS] = {0};
    

    // Boucle de jeu pour chaque manche
    for (int round = 1; round <= numRounds; round++) {
        
        //choisir une taille de grille aléatoire entre 15 et 20
        tailleGrille = rand() % 6 + 15;
        initializegrille(tailleGrille, numPlayers, players);
        displaygrille(tailleGrille);
        printf("\nManche %d\n", round);
        printf("Taille de la grille : %d\n\n", tailleGrille);

        // Assigner une cible à chaque joueur
        for (int i = 0; i < numPlayers; i++) {
            int cible = rand() % NUM_TARGETS;
            players[i].target = targets[cible];
            printf("Joueur %d - Votre objectif est la cible %c\n", i+1, players[i].target);
        }
        printf("\n");

        // Demander les prédictions de mouvements
        for (int i = 0; i < numPlayers; i++) {
            printf("Joueur %d - Prédiction de coups pour atteindre la cible %c : ", i+1, players[i].target);
            scanf("%d", &players[i].movesPredicted);
        }

        // Déterminer le joueur avec le moins de coups prédits
        int minPredictedMoves = players[0].movesPredicted;
        int startingPlayer = 0;
        for (int i = 1; i < numPlayers; i++) {
            if (players[i].movesPredicted < minPredictedMoves) {
                minPredictedMoves = players[i].movesPredicted;
                startingPlayer = i;
            }
        }
        
        
        
        // Déplacements des joueurs et calcul des résultats
        
        
        
         for (int i = 0; i < numPlayers; i++) {
            int movesTaken = 0;
            int targetReached = 0;
            int tempoX, tempoY;
            while (targetReached == 0 ) {
                // Afficher la grille
                displaygrille(tailleGrille);
                printf("Manche %d\n\n", round);
                printf("Joueur %d commence.\n\n", startingPlayer + 1);
                
                
                printf("nb de coups : %d\n\n", movesTaken);
                
                // Demander le déplacement au joueur
                char direction;
                printf("Joueur %d - Déplacement (haut/h, bas/b, gauche/g, droite/d, forfait/f) : \n", i+1);
                scanf(" %c", &direction);
                
                if (direction == 'f'|| direction == 'F'){   // si déclaré forfait
                    targetReached = 2;
                    printf("Tu as déclaré forfait, dommage.\n\n");
                break;
                }

                // Déplacer le joueur en ligne droite
                movePlayer(&players[i], direction, tailleGrille, players, targetReached); 
                movesTaken++;

                // Vérifier s'il atteint la cible
                if (grille[players[i].pos.x][players[i].pos.y] == players[i].target) {
                    targetReached = 1;
                    printf("BRAVO ! vous avez atteint la cible !\n\n");
                    break;
                }
            }

            // Calcul des résultats
            players[i].movesTaken = movesTaken; // Enregistrer le nombre de coups réels

            if (targetReached == 1 && movesTaken == players[i].movesPredicted) {
                roundScores[i] += 2; // Marquer 2 points pour une prédiction correcte
                
            } else if (targetReached == 1 && movesTaken < players[i].movesPredicted) {
                roundScores[i] -= 1; // Moins 1 point pour moins de coups que prévu 
            } else if (targetReached == 1 && movesTaken > players[i].movesPredicted || targetReached == 2) {
                for (int j = 0; j < numPlayers; j++) {
                    roundScores[j] += 1; // Marquer 1 point pour les autres joueurs
                }
            }
        }
    }

    // Afficher le score final et déterminer le gagnant
    printf("\nScore Final :\n");
    int maxScore = roundScores[0];
    int winner = 0;
    for (int i = 0; i < numPlayers; i++) {
        printf("Joueur %d : %d points\n", i+1, roundScores[i]);
        if (roundScores[i] > maxScore) {
            maxScore = roundScores[i];
            winner = i;
        }
    }
    printf("Le Joueur %d remporte la partie !\n", winner + 1);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int main() {
    int tailleGrille, numPlayers, numRounds, targetReached;
    srand(time(NULL));
    
    printf("\nBienvenue dans le jeu !\n\n");
    
    printf("Entrez le nombre de joueurs (max %d): ", MAX_PLAYERS);
    scanf("%d", &numPlayers);
    printf("Entrez le nombre de manches: ");
    scanf("%d", &numRounds);
    
    
    while (numPlayers < 1 || numPlayers > MAX_PLAYERS || numRounds < 1 || numRounds > 99) {
        printf("\n\nSaisie invalide, veuillez recommencer \n\n\n");
        printf("Entrez le nombre de joueurs (max %d): ", MAX_PLAYERS);
        scanf("%d", &numPlayers);
        printf("Entrez le nombre de manches: ");
        scanf("%d", &numRounds);
    }

    playGame(tailleGrille, numPlayers, numRounds);

    return 0;
}